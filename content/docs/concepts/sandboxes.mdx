---
title: Sandboxes
description: Isolated container environments for secure code execution with persistent volumes and warm pools.
---

## Overview

Persistent sandboxes are isolated container environments where AI agents execute code, install packages, and manipulate files. Each sandbox has a persistent volume that survives stop/resume cycles, giving agents stateful workspaces across conversations.

Agents need to run code, but arbitrary execution on the host is a security risk. Agents also lose context between tool calls without persistent filesystems, cold-starting a container per request is too slow (5-30 seconds), and multiple agents for the same user should not create duplicate environments. Sandboxes solve all four problems: isolated execution, persistent volumes, warm pool prewarming, and session affinity.

## How It Works

### Lifecycle

Every sandbox follows a state machine:

1. **Creating** — container is being provisioned with the requested image, resource limits, and volume
2. **Running** — sandbox is active and ready for command execution, file operations, and package installation
3. **Stopped** — sandbox is idle (either manually stopped or auto-stopped after the idle timeout). The persistent volume is preserved.
4. **Destroyed** — sandbox is permanently deleted after exceeding the stopped retention period. The volume is removed.

The transition from Running to Stopped happens automatically when a sandbox has been idle for longer than the configurable idle timeout. The transition from Stopped to Destroyed happens when the stopped retention period expires. Both thresholds are managed by a background lifecycle manager.

### Providers

MCP Gateway supports three sandbox providers, selected at deployment time:

**Docker (development)** — uses `aiodocker` for async Docker operations. Each sandbox gets a container and a named volume. Supports warm pools via the DockerWarmPool service.

**Kubernetes (production fallback)** — uses the Kubernetes async client to create Pods and PersistentVolumeClaims directly. Every create is a cold start (no warm pool).

**Agent Sandbox (production preferred)** — uses [kubernetes-sigs/agent-sandbox](https://github.com/kubernetes-sigs/agent-sandbox) CRDs for production-grade warm pool management. A `SandboxTemplate` defines the container spec, a `SandboxWarmPool` maintains N idle replicas, and a `SandboxClaim` atomically allocates from the pool for sub-second sandbox provisioning.

### Warm Pools

Warm pools pre-create containers so that when a user requests a sandbox, one is allocated instantly instead of waiting for a cold start. The pool continuously replenishes to maintain the target count of idle containers.

In development (Docker), the `DockerWarmPool` service manages a pool of pre-created containers labeled for warm pool tracking. In production (Agent Sandbox), the Kubernetes CRD controller handles pool management natively.

### Session Affinity

When a sandbox is requested with a session key, the gateway first checks if an existing sandbox is already assigned to that session. If so, the same sandbox is returned — preventing duplicate environments for the same user or conversation. This is critical for the playground experience where agents interact with the same workspace across multiple turns.

### File Operations

Sandboxes support full filesystem operations through the API:

- **Upload files** — push files into the sandbox workspace
- **Download files** — retrieve files from the sandbox
- **List files** — browse the sandbox filesystem
- **Execute commands** — run shell commands with configurable timeouts

All file paths are validated to prevent path traversal attacks.

## Key Features

- **Container isolation** — each sandbox runs in its own container with CPU, memory, and disk limits
- **Persistent volumes** — Docker volumes (dev) or Kubernetes PVCs (prod) survive stop/resume cycles
- **Warm pools** — pre-created containers for sub-second allocation instead of 5-30 second cold starts
- **Session affinity** — same session key reuses the same sandbox, preventing duplicates
- **Network isolation** — network is disabled by default; can be enabled per sandbox
- **Automatic lifecycle** — idle sandboxes are stopped automatically, stopped sandboxes are destroyed after retention period
- **Custom images** — admin-managed sandbox images with build pipeline and approval workflow
- **Quota enforcement** — per-user limits on concurrent sandboxes and resource consumption
- **Three providers** — Docker for development, Kubernetes and Agent Sandbox CRDs for production
- **Background management** — lifecycle manager handles auto-stop, archive, destroy, and warm pool replenishment

## API Reference

- [List sandboxes](/docs/api/sandboxes) — retrieve all sandboxes for the current user
- [Create a sandbox](/docs/api/sandboxes) — provision a new sandbox with a specific image and resource limits
- [Execute command](/docs/api/sandboxes) — run a shell command in a sandbox
- [File operations](/docs/api/sandboxes) — upload, download, and list files in a sandbox
- [Stop / Resume](/docs/api/sandboxes) — pause and resume sandbox containers
